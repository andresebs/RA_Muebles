<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AR Furniture Pro: Precision Control</title>

    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        /* --- GLOBAL STYLES --- */
        * { box-sizing: border-box; }
        body { margin: 0; overflow: hidden; font-family: sans-serif; }

        /* --- UI OVERLAY LAYER --- */
        #ui-layer {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100;
            pointer-events: none; /* Let touches pass to 3D scene */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Top Bar */
        .top-bar {
            pointer-events: auto;
            background: rgba(0,0,0,0.6);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
        }

        .furniture-select {
            width: 100%; padding: 8px; font-size: 16px; border-radius: 5px;
        }

        /* Control Panel (Bottom) */
        .control-panel {
            pointer-events: auto;
            background: rgba(20, 20, 20, 0.9);
            padding: 15px;
            border-radius: 15px 15px 0 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            color: white;
        }

        /* Button Grids */
        .grid-row {
            display: flex; justify-content: space-between; gap: 10px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: 1px solid #555;
            background: #333;
            color: white;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
        }

        .btn:active { background: #666; }
        
        /* Active States */
        .btn.active-mode { background: #007bff; border-color: #0056b3; }
        .btn.active-axis { background: #ffc107; color: black; border-color: #d39e00; }
        .btn-action { background: #28a745; font-size: 20px; }
        .btn-lock { background: #dc3545; } /* Red for Lock/Reset */

        /* Labels inside control panel */
        .panel-label { font-size: 12px; color: #aaa; margin-bottom: 2px; text-transform: uppercase; }

    </style>
</head>
<body>

    <div id="ui-layer">
        
        <div class="top-bar">
            <select id="furniture-select" class="furniture-select">
                <option value="chair">Chair (Default: 0.5x1.0x0.5)</option>
                <option value="table">Table (Default: 1.2x0.8x0.8)</option>
                <option value="bed">Bed (Default: 1.5x0.6x2.0)</option>
                <option value="wardrobe">Wardrobe (Default: 1.0x2.0x0.6)</option>
            </select>
        </div>

        <div class="control-panel">
            
            <div class="grid-row">
                <div style="flex:1">
                    <div class="panel-label">Mode</div>
                    <div class="grid-row">
                        <button class="btn active-mode" id="mode-scale" onclick="setMode('scale')">Size</button>
                        <button class="btn" id="mode-rotate" onclick="setMode('rotate')">Rotate</button>
                    </div>
                </div>
                <div style="flex:1">
                    <div class="panel-label">Axis</div>
                    <div class="grid-row">
                        <button class="btn active-axis" id="axis-x" onclick="setAxis('x')">X</button>
                        <button class="btn" id="axis-y" onclick="setAxis('y')">Y</button>
                        <button class="btn" id="axis-z" onclick="setAxis('z')">Z</button>
                    </div>
                </div>
            </div>

            <div class="grid-row">
                <button class="btn btn-action" onclick="adjustValue(-1)">âž–</button>
                <button class="btn btn-action" onclick="adjustValue(1)">âž•</button>
            </div>

            <button class="btn btn-lock" id="btn-lock-toggle" onclick="toggleLockSystem()">ðŸ”’ Lock / Place Furniture</button>
        </div>
    </div>

    <a-scene embedded arjs='sourceType: webcam; debugUIEnabled: false;' vr-mode-ui="enabled: false" renderer="logarithmicDepthBuffer: true;">
        
        <a-marker preset="hiro" id="marker-root">
            <a-entity id="ghost-model">
                <a-box id="ghost-box" color="yellow" material="opacity: 0.5; transparent: true"></a-box>
            </a-entity>
        </a-marker>

        <a-entity id="world-container" visible="false">
            <a-entity id="active-furniture">
                <a-box id="furniture-box" color="#007bff"></a-box>
                
                <a-text id="label-x" value="X: 1.0m" color="red" align="center" scale="0.5 0.5 0.5" position="0 0 0"></a-text>
                <a-text id="label-y" value="Y: 1.0m" color="green" align="center" scale="0.5 0.5 0.5" position="0 0 0"></a-text>
                <a-text id="label-z" value="Z: 1.0m" color="blue" align="center" scale="0.5 0.5 0.5" position="0 0 0"></a-text>
            </a-entity>
        </a-entity>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // --- CONFIGURATION ---
        const furnitureDB = {
            chair: { w: 0.5, h: 1.0, d: 0.5 },
            table: { w: 1.2, h: 0.8, d: 0.8 },
            bed:   { w: 1.5, h: 0.6, d: 2.0 },
            wardrobe: { w: 1.0, h: 2.0, d: 0.6 }
        };

        // State Variables
        let currentMode = 'scale'; // 'scale' or 'rotate'
        let currentAxis = 'x';     // 'x', 'y', 'z'
        let isLocked = false;
        let baseDimensions = { ...furnitureDB.chair }; // Copy of default dimensions

        // DOM Elements
        const furnitureBox = document.getElementById('furniture-box');
        const worldContainer = document.getElementById('world-container');
        const activeFurniture = document.getElementById('active-furniture');
        const ghostModel = document.getElementById('ghost-model');
        const ghostBox = document.getElementById('ghost-box');
        const markerRoot = document.getElementById('marker-root');
        
        // Labels
        const lblX = document.getElementById('label-x');
        const lblY = document.getElementById('label-y');
        const lblZ = document.getElementById('label-z');

        // --- INITIALIZATION ---
        function init() {
            updateGhost('chair');
        }

        // --- UI FUNCTIONS ---
        
        function setMode(mode) {
            currentMode = mode;
            // Update UI Styling
            document.querySelectorAll('[id^="mode-"]').forEach(b => b.classList.remove('active-mode'));
            document.getElementById(`mode-${mode}`).classList.add('active-mode');
        }

        function setAxis(axis) {
            currentAxis = axis;
            // Update UI Styling
            document.querySelectorAll('[id^="axis-"]').forEach(b => b.classList.remove('active-axis'));
            document.getElementById(`axis-${axis}`).classList.add('active-axis');
        }

        document.getElementById('furniture-select').addEventListener('change', (e) => {
            baseDimensions = { ...furnitureDB[e.target.value] };
            updateGhost(e.target.value);
            
            // If locked, reset the shape of the placed object too
            if(isLocked) {
                updateFurnitureShape();
            }
        });

        // --- LOGIC FUNCTIONS ---

        // 1. Ghost Logic (Preview)
        function updateGhost(type) {
            const dims = furnitureDB[type];
            ghostBox.setAttribute('width', dims.w);
            ghostBox.setAttribute('height', dims.h);
            ghostBox.setAttribute('depth', dims.d);
            ghostBox.setAttribute('position', `0 ${dims.h/2} 0`);
        }

        // 2. Lock / Unlock System
        function toggleLockSystem() {
            const btn = document.getElementById('btn-lock-toggle');
            
            if (!isLocked) {
                // LOCK ACTION
                if (!markerRoot.object3D.visible) {
                    alert("Marker not found! Please look at the Hiro image.");
                    return;
                }

                // Copy positions from Ghost to World
                const ghostPos = new THREE.Vector3();
                const ghostQuat = new THREE.Quaternion();
                ghostModel.object3D.getWorldPosition(ghostPos);
                ghostModel.object3D.getWorldQuaternion(ghostQuat);

                worldContainer.object3D.position.copy(ghostPos);
                worldContainer.object3D.quaternion.copy(ghostQuat);

                updateFurnitureShape(); // Apply dimensions
                
                worldContainer.setAttribute('visible', true);
                ghostModel.setAttribute('visible', false);
                
                isLocked = true;
                btn.innerText = "ðŸ”“ Unlock / Reset";
                btn.style.background = "#6c757d"; // Grey

            } else {
                // UNLOCK ACTION (Reset)
                isLocked = false;
                worldContainer.setAttribute('visible', false);
                ghostModel.setAttribute('visible', true);
                
                // Reset Transforms
                activeFurniture.setAttribute('scale', '1 1 1');
                activeFurniture.setAttribute('rotation', '0 0 0');
                
                btn.innerText = "ðŸ”’ Lock / Place Furniture";
                btn.style.background = "#dc3545"; // Red
            }
        }

        // 3. Update Visual Shape & Labels
        function updateFurnitureShape() {
            // Apply Base Dimensions
            furnitureBox.setAttribute('width', baseDimensions.w);
            furnitureBox.setAttribute('height', baseDimensions.h);
            furnitureBox.setAttribute('depth', baseDimensions.d);
            furnitureBox.setAttribute('position', `0 ${baseDimensions.h/2} 0`);
            
            updateLabels();
        }

        // 4. Transform Logic (Scale & Rotate)
        function adjustValue(direction) {
            if (!isLocked) {
                alert("Please LOCK the furniture first to edit it.");
                return;
            }

            const entity = activeFurniture; // We manipulate the container wrapper

            if (currentMode === 'scale') {
                const currentScale = entity.getAttribute('scale');
                const step = 0.1 * direction; // 10% change
                
                // Calculate new scale (prevent negative)
                let newScaleVal = currentScale[currentAxis] + step;
                if (newScaleVal < 0.1) newScaleVal = 0.1;

                // Create new object strictly for the attribute
                let newScaleObj = { x: currentScale.x, y: currentScale.y, z: currentScale.z };
                newScaleObj[currentAxis] = newScaleVal;

                entity.setAttribute('scale', newScaleObj);
                updateLabels(); // Update text measurements

            } else if (currentMode === 'rotate') {
                const currentRot = entity.getAttribute('rotation');
                const step = 15 * direction; // 15 degrees

                let newRotObj = { x: currentRot.x, y: currentRot.y, z: currentRot.z };
                newRotObj[currentAxis] += step;

                entity.setAttribute('rotation', newRotObj);
                // No need to update labels for rotation
            }
        }

        // 5. Dynamic Labels Logic
        function updateLabels() {
            const currentScale = activeFurniture.getAttribute('scale');
            
            // Calculate Real World Size = Base Size * Scale Factor
            const realW = (baseDimensions.w * currentScale.x).toFixed(2);
            const realH = (baseDimensions.h * currentScale.y).toFixed(2);
            const realD = (baseDimensions.d * currentScale.z).toFixed(2);

            // Update Text
            lblX.setAttribute('value', `W: ${realW}m`);
            lblY.setAttribute('value', `H: ${realH}m`);
            lblZ.setAttribute('value', `D: ${realD}m`);

            // Position Labels smartly around the object
            // X Label: To the right
            lblX.setAttribute('position', `${(baseDimensions.w/2) + 0.3} ${baseDimensions.h/2} 0`);
            
            // Y Label: On top
            lblY.setAttribute('position', `0 ${baseDimensions.h + 0.3} 0`);
            
            // Z Label: To the front
            lblZ.setAttribute('position', `0 ${baseDimensions.h/2} ${(baseDimensions.d/2) + 0.3}`);
        }

        // Run Init
        init();

    </script>
</body>
</html>