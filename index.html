<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AR Furniture: Cupboard Test</title>

    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        /* --- UI STYLES (Clean Code & Mobile Optimized) --- */
        * { box-sizing: border-box; }
        body { margin: 0; overflow: hidden; font-family: sans-serif; }
        
        #ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 10px; padding-bottom: env(safe-area-inset-bottom);
        }
        
        .top-bar { pointer-events: auto; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 10px; text-align: center; }
        .furniture-select { width: 100%; padding: 8px; font-size: 16px; border-radius: 5px; }
        
        .control-panel {
            pointer-events: auto; background: rgba(20, 20, 20, 0.9); padding: 15px;
            border-radius: 15px 15px 0 0; display: flex; flex-direction: column; gap: 10px; color: white;
        }
        
        .grid-row { display: flex; justify-content: space-between; gap: 10px; }
        
        .btn {
            flex: 1; padding: 12px; border: 1px solid #555; background: #333; color: white;
            border-radius: 8px; font-weight: bold; cursor: pointer; user-select: none;
        }
        .btn:active { background: #666; }
        .btn.active-mode { background: #007bff; border-color: #0056b3; }
        .btn.active-axis { background: #ffc107; color: black; border-color: #d39e00; }
        .btn-action { background: #28a745; font-size: 20px; }
        .btn-lock { background: #dc3545; }
        .panel-label { font-size: 12px; color: #aaa; margin-bottom: 2px; text-transform: uppercase; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="top-bar">
            <select id="furniture-select" class="furniture-select">
                <option value="wardrobe">Armario (cupboard.glb)</option>
                <option value="chair">Chair (Shape Only)</option>
                <option value="table">Table (Shape Only)</option>
                <option value="bed">Bed (Shape Only)</option>
            </select>
        </div>

        <div class="control-panel">
            <div class="grid-row">
                <div style="flex:1">
                    <div class="panel-label">Mode</div>
                    <div class="grid-row">
                        <button class="btn active-mode" id="mode-scale" onclick="setMode('scale')">Size</button>
                        <button class="btn" id="mode-rotate" onclick="setMode('rotate')">Rotate</button>
                    </div>
                </div>
                <div style="flex:1">
                    <div class="panel-label">Axis</div>
                    <div class="grid-row">
                        <button class="btn active-axis" id="axis-x" onclick="setAxis('x')">X</button>
                        <button class="btn" id="axis-y" onclick="setAxis('y')">Y</button>
                        <button class="btn" id="axis-z" onclick="setAxis('z')">Z</button>
                    </div>
                </div>
            </div>
            <div class="grid-row">
                <button class="btn btn-action" onclick="adjustValue(-1)">âž–</button>
                <button class="btn btn-action" onclick="adjustValue(1)">âž•</button>
            </div>
            <button class="btn btn-lock" id="btn-lock-toggle" onclick="toggleLockSystem()">ðŸ”’ Lock / Place Furniture</button>
        </div>
    </div>

    <a-scene embedded arjs='sourceType: webcam; debugUIEnabled: false;' vr-mode-ui="enabled: false" renderer="logarithmicDepthBuffer: true;">
        
        <a-assets>
            <a-asset-item id="model-cupboard" src="cupboard.glb"></a-asset-item>
        </a-assets>

        <a-marker preset="hiro" id="marker-root">
            <a-entity id="ghost-container" scale="1 1 1">
                <a-box id="ghost-box" material="opacity: 0.3; color: yellow; transparent: true"></a-box>
            </a-entity>
        </a-marker>

        <a-entity id="world-container" visible="false">
            <a-entity id="active-furniture-wrapper">
                
                <a-entity id="furniture-model-entity"></a-entity>

                <a-text id="label-x" value="W" color="red" align="center" scale="0.5 0.5 0.5"></a-text>
                <a-text id="label-y" value="H" color="green" align="center" scale="0.5 0.5 0.5"></a-text>
                <a-text id="label-z" value="D" color="blue" align="center" scale="0.5 0.5 0.5"></a-text>
            </a-entity>
        </a-entity>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // --- DATABASE ---
        const furnitureDB = {
            wardrobe: { 
                // Dimensions in meters (approximate for collider/ghost)
                w: 1.0, h: 2.0, d: 0.6, 
                // ENABLE MODEL FOR WARDROBE
                useModel: true, 
                modelId: '#model-cupboard',
                // Adjust this if the GLB is too big/small (e.g. 0.01 if in cm, 1 if in meters)
                scaleCorrection: 1 
            },
            chair: { 
                w: 0.5, h: 1.0, d: 0.5, 
                useModel: false, // Shape only
                color: '#FF5733' 
            },
            table: { 
                w: 1.5, h: 0.8, d: 0.9, 
                useModel: false, // Shape only
                color: '#8B4513' 
            },
            bed: { 
                w: 1.6, h: 0.6, d: 2.0, 
                useModel: false, // Shape only
                color: '#3357FF' 
            }
        };

        // --- STATE & VARS ---
        let currentType = 'wardrobe'; // Default to wardrobe for testing
        let currentMode = 'scale';
        let currentAxis = 'x';
        let isLocked = false;
        
        // DOM Elements
        const worldContainer = document.getElementById('world-container');
        const activeWrapper = document.getElementById('active-furniture-wrapper');
        const furnitureEntity = document.getElementById('furniture-model-entity');
        const markerRoot = document.getElementById('marker-root');
        const ghostContainer = document.getElementById('ghost-container');
        const ghostBox = document.getElementById('ghost-box');

        const lblX = document.getElementById('label-x');
        const lblY = document.getElementById('label-y');
        const lblZ = document.getElementById('label-z');

        function init() {
            updateGhostVisuals();
        }

        // --- SELECTION SYSTEM ---
        document.getElementById('furniture-select').addEventListener('change', (e) => {
            currentType = e.target.value;
            if(isLocked) renderFurnitureModel();
            updateGhostVisuals();
        });

        function setMode(mode) {
            currentMode = mode;
            updateUI();
        }

        function setAxis(axis) {
            currentAxis = axis;
            updateUI();
        }

        function updateUI() {
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('active-mode', 'active-axis'));
            document.getElementById(`mode-${currentMode}`).classList.add('active-mode');
            document.getElementById(`axis-${currentAxis}`).classList.add('active-axis');
        }

        // --- RENDER LOGIC ---

        function updateGhostVisuals() {
            const data = furnitureDB[currentType];
            ghostBox.setAttribute('width', data.w);
            ghostBox.setAttribute('height', data.h);
            ghostBox.setAttribute('depth', data.d);
            ghostBox.setAttribute('position', `0 ${data.h/2} 0`);
        }

        function renderFurnitureModel() {
            const data = furnitureDB[currentType];
            
            // Clear previous model
            furnitureEntity.innerHTML = '';
            furnitureEntity.removeAttribute('gltf-model');

            if (data.useModel) {
                // LOAD GLB MODEL
                furnitureEntity.setAttribute('gltf-model', data.modelId);
                
                // Scale Correction & Centering
                const s = data.scaleCorrection || 1;
                furnitureEntity.setAttribute('scale', `${s} ${s} ${s}`);
                furnitureEntity.setAttribute('position', '0 0 0');

            } else {
                // LOAD PLACEHOLDER BOX
                const box = document.createElement('a-box');
                box.setAttribute('width', data.w);
                box.setAttribute('height', data.h);
                box.setAttribute('depth', data.d);
                box.setAttribute('color', data.color || 'white');
                box.setAttribute('position', `0 ${data.h/2} 0`);
                furnitureEntity.appendChild(box);
            }

            updateLabels();
        }

        // --- LOCK SYSTEM ---

        function toggleLockSystem() {
            const btn = document.getElementById('btn-lock-toggle');
            
            if (!isLocked) {
                // LOCK
                if (!markerRoot.object3D.visible) {
                    alert("Marker not found! Point camera at Hiro image.");
                    return;
                }

                // Copy Transform
                const ghostPos = new THREE.Vector3();
                const ghostQuat = new THREE.Quaternion();
                ghostContainer.object3D.getWorldPosition(ghostPos);
                ghostContainer.object3D.getWorldQuaternion(ghostQuat);

                worldContainer.object3D.position.copy(ghostPos);
                worldContainer.object3D.quaternion.copy(ghostQuat);
                
                renderFurnitureModel();
                
                worldContainer.setAttribute('visible', true);
                markerRoot.setAttribute('visible', false); 
                
                isLocked = true;
                btn.innerText = "ðŸ”“ Unlock / Reset";
                btn.style.background = "#6c757d";

            } else {
                // UNLOCK
                isLocked = false;
                worldContainer.setAttribute('visible', false);
                markerRoot.setAttribute('visible', true);
                
                // Reset Transforms
                activeWrapper.setAttribute('scale', '1 1 1');
                activeWrapper.setAttribute('rotation', '0 0 0');
                
                btn.innerText = "ðŸ”’ Lock / Place Furniture";
                btn.style.background = "#dc3545";
            }
        }

        // --- TRANSFORM SYSTEM ---

        function adjustValue(direction) {
            if (!isLocked) {
                alert("Please LOCK first.");
                return;
            }

            if (currentMode === 'scale') {
                const currentScale = activeWrapper.getAttribute('scale');
                const step = 0.1 * direction;
                let newVal = Math.max(0.1, currentScale[currentAxis] + step);
                
                let newScaleObj = { ...currentScale };
                newScaleObj[currentAxis] = newVal;
                
                activeWrapper.setAttribute('scale', newScaleObj);
                updateLabels();

            } else {
                // Rotate
                const currentRot = activeWrapper.getAttribute('rotation');
                const step = 15 * direction;
                let newRotObj = { ...currentRot };
                newRotObj[currentAxis] += step;
                activeWrapper.setAttribute('rotation', newRotObj);
            }
        }

        function updateLabels() {
            const data = furnitureDB[currentType];
            const currentScale = activeWrapper.getAttribute('scale');

            // Real Size = Base Size * Scale Factor
            const rw = (data.w * currentScale.x).toFixed(2);
            const rh = (data.h * currentScale.y).toFixed(2);
            const rd = (data.d * currentScale.z).toFixed(2);

            lblX.setAttribute('value', `W: ${rw}m`);
            lblY.setAttribute('value', `H: ${rh}m`);
            lblZ.setAttribute('value', `D: ${rd}m`);

            // Position Labels
            const limitW = (data.w * currentScale.x) / 2;
            const limitH = (data.h * currentScale.y);
            const limitD = (data.d * currentScale.z) / 2;

            lblX.setAttribute('position', `${limitW + 0.2} ${limitH/2} 0`);
            lblY.setAttribute('position', `0 ${limitH + 0.2} 0`);
            lblZ.setAttribute('position', `0 ${limitH/2} ${limitD + 0.2}`);
        }

        // Init
        init();
        updateUI();

    </script>
</body>
</html>