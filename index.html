<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AR Furniture: Fixed Orientation</title>

    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        /* --- UI STYLES --- */
        * { box-sizing: border-box; }
        body { margin: 0; overflow: hidden; font-family: sans-serif; background-color: #000; }
        
        #ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 10px; padding-bottom: env(safe-area-inset-bottom);
        }
        
        .top-bar { pointer-events: auto; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 10px; text-align: center; }
        .furniture-select { width: 100%; padding: 8px; font-size: 16px; border-radius: 5px; font-weight: bold;}
        
        .control-panel {
            pointer-events: auto; background: rgba(20, 20, 20, 0.95); padding: 15px;
            border-radius: 15px 15px 0 0; display: flex; flex-direction: column; gap: 10px; color: white;
        }
        
        .grid-row { display: flex; justify-content: space-between; gap: 10px; }
        
        .btn {
            flex: 1; padding: 12px; border: 1px solid #555; background: #333; color: white;
            border-radius: 8px; font-weight: bold; cursor: pointer; user-select: none;
        }
        .btn:active { background: #666; transform: scale(0.98); }
        .btn.active-mode { background: #007bff; border-color: #0056b3; }
        .btn.active-axis { background: #ffc107; color: black; border-color: #d39e00; }
        .btn-action { background: #28a745; font-size: 20px; }
        .btn-lock { background: #dc3545; font-size: 16px; text-transform: uppercase; letter-spacing: 1px;}
        .panel-label { font-size: 12px; color: #aaa; margin-bottom: 2px; text-transform: uppercase; }
        
        /* Mensaje de estado para depuraciÃ³n */
        #debug-msg {
            position: absolute; top: 60px; left: 0; width: 100%; 
            text-align: center; color: yellow; text-shadow: 1px 1px 1px black;
            font-size: 14px; pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="top-bar">
            <select id="furniture-select" class="furniture-select">
                <option value="wardrobe">Armario (Cupboard)</option>
                <option value="chair">Silla (Shape)</option>
                <option value="table">Mesa (Shape)</option>
                <option value="bed">Cama (Shape)</option>
            </select>
        </div>
        
        <div id="debug-msg">Scan Hiro Marker</div>

        <div class="control-panel">
            <div class="grid-row">
                <div style="flex:1">
                    <div class="panel-label">Mode</div>
                    <div class="grid-row">
                        <button class="btn active-mode" id="mode-scale" onclick="setMode('scale')">Size</button>
                        <button class="btn" id="mode-rotate" onclick="setMode('rotate')">Rotate</button>
                    </div>
                </div>
                <div style="flex:1">
                    <div class="panel-label">Axis</div>
                    <div class="grid-row">
                        <button class="btn active-axis" id="axis-x" onclick="setAxis('x')">X</button>
                        <button class="btn" id="axis-y" onclick="setAxis('y')">Y</button>
                        <button class="btn" id="axis-z" onclick="setAxis('z')">Z</button>
                    </div>
                </div>
            </div>
            <div class="grid-row">
                <button class="btn btn-action" onclick="adjustValue(-1)">âž–</button>
                <button class="btn btn-action" onclick="adjustValue(1)">âž•</button>
            </div>
            <button class="btn btn-lock" id="btn-lock-toggle" onclick="toggleLockSystem()">ðŸ”’ Lock / Place</button>
        </div>
    </div>

    <a-scene embedded arjs='sourceType: webcam; debugUIEnabled: false;' vr-mode-ui="enabled: false" renderer="logarithmicDepthBuffer: true; colorManagement: true;">
        
        <a-assets>
            <a-asset-item id="model-cupboard" src="cupboard.glb"></a-asset-item>
        </a-assets>

        <a-marker preset="hiro" id="marker-root" emitevents="true">
            <a-entity id="ghost-container" position="0 0 0" rotation="0 0 0" scale="1 1 1">
                 <a-box id="ghost-box" material="opacity: 0.5; color: yellow; transparent: true"></a-box>
            </a-entity>
        </a-marker>

        <a-entity id="world-container" visible="false">
            <a-entity id="user-transform-wrapper">
                
                <a-entity id="model-correction-wrapper">
                    <a-entity id="furniture-content"></a-entity>
                </a-entity>

                <a-text id="label-x" value="W" color="red" align="center" scale="0.5 0.5 0.5"></a-text>
                <a-text id="label-y" value="H" color="green" align="center" scale="0.5 0.5 0.5"></a-text>
                <a-text id="label-z" value="D" color="blue" align="center" scale="0.5 0.5 0.5"></a-text>
            </a-entity>
        </a-entity>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // --- BASE DE DATOS DE MUEBLES ---
        const furnitureDB = {
            wardrobe: { 
                w: 1.0, h: 2.0, d: 0.6, 
                useModel: true, 
                modelId: '#model-cupboard',
                scaleCorrection: 1,
                // ROTATION FIX: Si se ve "desde arriba" (acostado), prueba '-90 0 0'.
                // Si se ve de espaldas, prueba '0 180 0'.
                rotationFix: '0 0 0' 
            },
            chair: { 
                w: 0.5, h: 1.0, d: 0.5, 
                useModel: false, 
                color: '#FF5733',
                rotationFix: '0 0 0'
            },
            table: { 
                w: 1.5, h: 0.8, d: 0.9, 
                useModel: false, 
                color: '#8B4513',
                rotationFix: '0 0 0'
            },
            bed: { 
                w: 1.6, h: 0.6, d: 2.0, 
                useModel: false, 
                color: '#3357FF',
                rotationFix: '0 0 0'
            }
        };

        // --- VARIABLES ---
        let currentType = 'wardrobe';
        let currentMode = 'scale';
        let currentAxis = 'x';
        let isLocked = false;

        // --- REFERENCIAS DOM ---
        const worldContainer = document.getElementById('world-container');
        const userWrapper = document.getElementById('user-transform-wrapper'); // Escala/RotaciÃ³n usuario
        const correctionWrapper = document.getElementById('model-correction-wrapper'); // RotaciÃ³n fija del modelo
        const furnitureContent = document.getElementById('furniture-content');
        
        const markerRoot = document.getElementById('marker-root');
        const ghostContainer = document.getElementById('ghost-container');
        const ghostBox = document.getElementById('ghost-box');
        const debugMsg = document.getElementById('debug-msg');

        const lblX = document.getElementById('label-x');
        const lblY = document.getElementById('label-y');
        const lblZ = document.getElementById('label-z');

        // --- INICIO ---
        function init() {
            updateGhostVisuals();
        }

        // --- UI HANDLERS ---
        document.getElementById('furniture-select').addEventListener('change', (e) => {
            currentType = e.target.value;
            // Si estÃ¡ bloqueado, recargamos el modelo en el mundo real
            if(isLocked) {
                renderRealModel();
            }
            updateGhostVisuals();
        });

        function setMode(mode) {
            currentMode = mode;
            updateButtonStyles();
        }

        function setAxis(axis) {
            currentAxis = axis;
            updateButtonStyles();
        }

        function updateButtonStyles() {
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('active-mode', 'active-axis'));
            document.getElementById(`mode-${currentMode}`).classList.add('active-mode');
            document.getElementById(`axis-${currentAxis}`).classList.add('active-axis');
        }

        // --- LÃ“GICA VISUAL ---

        function updateGhostVisuals() {
            const data = furnitureDB[currentType];
            // Actualizamos la caja amarilla fantasma
            ghostBox.setAttribute('width', data.w);
            ghostBox.setAttribute('height', data.h);
            ghostBox.setAttribute('depth', data.d);
            // Centramos la caja fantasma para que se pose SOBRE el marcador, no mitad dentro
            ghostBox.setAttribute('position', `0 ${data.h/2} 0`);
        }

        function renderRealModel() {
            const data = furnitureDB[currentType];
            
            // 1. Limpiamos contenido previo
            furnitureContent.innerHTML = '';
            furnitureContent.removeAttribute('gltf-model');
            furnitureContent.removeAttribute('geometry');
            furnitureContent.removeAttribute('material');

            // 2. Aplicamos la correcciÃ³n de rotaciÃ³n (Para que no se vea desde arriba)
            // Esto rota el contenedor interno, no el wrapper del usuario
            correctionWrapper.setAttribute('rotation', data.rotationFix || '0 0 0');

            if (data.useModel) {
                // MODELO 3D
                furnitureContent.setAttribute('gltf-model', data.modelId);
                
                // Escala inicial del modelo GLB (correcciÃ³n de importaciÃ³n)
                const s = data.scaleCorrection || 1;
                furnitureContent.setAttribute('scale', `${s} ${s} ${s}`);
                
                // PosiciÃ³n: A-Frame centra los modelos en (0,0,0). 
                // Normalmente no necesitamos elevar el GLB si su pivote estÃ¡ en la base.
                // Si el modelo flota, cambia esto a '0 0 0'.
                furnitureContent.setAttribute('position', '0 0 0'); 

            } else {
                // FIGURA GEOMÃ‰TRICA (Placeholder)
                const box = document.createElement('a-box');
                box.setAttribute('width', data.w);
                box.setAttribute('height', data.h);
                box.setAttribute('depth', data.d);
                box.setAttribute('color', data.color);
                // Elevar la caja la mitad de su altura para que se pose en el suelo
                box.setAttribute('position', `0 ${data.h/2} 0`);
                furnitureContent.appendChild(box);
            }

            // Actualizar textos de medidas
            updateLabels();
        }

        // --- SISTEMA DE BLOQUEO (CRITICO) ---

        function toggleLockSystem() {
            const btn = document.getElementById('btn-lock-toggle');

            if (!isLocked) {
                // --- ACCIÃ“N: BLOQUEAR ---
                
                // VerificaciÃ³n estricta de visibilidad del marcador
                if (!markerRoot.object3D.visible) {
                    alert("Â¡No veo el marcador Hiro! EnfÃ³calo antes de bloquear.");
                    return;
                }

                // 1. Calcular posiciÃ³n absoluta en el mundo 3D
                const worldPos = new THREE.Vector3();
                const worldQuat = new THREE.Quaternion();
                const worldScale = new THREE.Vector3(); // Capturamos escala tambiÃ©n por si acaso

                markerRoot.object3D.getWorldPosition(worldPos);
                markerRoot.object3D.getWorldQuaternion(worldQuat);
                markerRoot.object3D.getWorldScale(worldScale);

                // 2. Aplicar al contenedor persistente
                worldContainer.object3D.position.copy(worldPos);
                worldContainer.object3D.quaternion.copy(worldQuat);
                // Forzamos escala 1 en el contenedor principal para evitar distorsiones del marcador
                worldContainer.object3D.scale.set(1, 1, 1); 

                // 3. Renderizar el modelo real
                renderRealModel();

                // 4. GestiÃ³n de visibilidad
                worldContainer.setAttribute('visible', true);
                
                // TRUCO: Ocultamos el contenido del marcador, pero NO el marcador en sÃ­
                // para que AR.js siga traqueando si es necesario, aunque visualmente ya tenemos el objeto fijo.
                ghostContainer.setAttribute('visible', false);

                isLocked = true;
                btn.innerText = "ðŸ”“ UNLOCK / RESET";
                btn.style.background = "#6c757d";
                debugMsg.innerText = "Modelo Bloqueado. Puedes moverte.";
                debugMsg.style.color = "#00FF00";

            } else {
                // --- ACCIÃ“N: DESBLOQUEAR ---
                isLocked = false;
                
                // Ocultar modelo fijo
                worldContainer.setAttribute('visible', false);
                // Mostrar fantasma de nuevo
                ghostContainer.setAttribute('visible', true);

                // Resetear transformaciones de usuario
                userWrapper.setAttribute('scale', '1 1 1');
                userWrapper.setAttribute('rotation', '0 0 0');

                btn.innerText = "ðŸ”’ LOCK / PLACE";
                btn.style.background = "#dc3545";
                debugMsg.innerText = "Escanea el marcador Hiro";
                debugMsg.style.color = "yellow";
            }
        }


        // --- SISTEMA DE TRANSFORMACIÃ“N ---

        function adjustValue(direction) {
            if (!isLocked) {
                alert("Primero bloquea (LOCK) el mueble.");
                return;
            }

            // Modificamos el 'userWrapper', no el modelo directamente
            if (currentMode === 'scale') {
                const currentScale = userWrapper.getAttribute('scale');
                const step = 0.1 * direction;
                let newVal = Math.max(0.1, currentScale[currentAxis] + step);
                
                let newScaleObj = { ...currentScale };
                newScaleObj[currentAxis] = newVal;
                
                userWrapper.setAttribute('scale', newScaleObj);
                updateLabels();

            } else {
                // RotaciÃ³n
                const currentRot = userWrapper.getAttribute('rotation');
                const step = 15 * direction;
                
                let newRotObj = { ...currentRot };
                newRotObj[currentAxis] += step;
                
                userWrapper.setAttribute('rotation', newRotObj);
            }
        }

        function updateLabels() {
            const data = furnitureDB[currentType];
            const currentScale = userWrapper.getAttribute('scale');

            // Calculamos dimensiones reales visuales
            const rw = (data.w * currentScale.x).toFixed(2);
            const rh = (data.h * currentScale.y).toFixed(2);
            const rd = (data.d * currentScale.z).toFixed(2);

            lblX.setAttribute('value', `W: ${rw}m`);
            lblY.setAttribute('value', `H: ${rh}m`);
            lblZ.setAttribute('value', `D: ${rd}m`);

            // Posicionamos etiquetas relativas al tamaÃ±o actual
            // Usamos las dimensiones base * escala
            const limitW = (data.w * currentScale.x) / 2;
            const limitH = (data.h * currentScale.y); // Altura total
            const limitD = (data.d * currentScale.z) / 2;

            // X a la derecha
            lblX.setAttribute('position', `${limitW + 0.2} ${limitH/2} 0`);
            // Y arriba del todo
            lblY.setAttribute('position', `0 ${limitH + 0.2} 0`);
            // Z al frente
            lblZ.setAttribute('position', `0 ${limitH/2} ${limitD + 0.2}`);
        }

        // Init
        init();
        updateButtonStyles();

    </script>
</body>
</html>